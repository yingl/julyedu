# 聚合函数

在做数据分析时，我们经常遇到需要对数据进行分组处理。比如统计某个用户的消费总金额，某个商品的总销售量，商品的平均售价等。如果你对SQL熟悉的话一定经常使用group by语句，然后对分组后的数据应用聚合函数。

第一次听到聚合函数这个词可能有点陌生，但是对于求和，求平均值之类的操作你一定非常熟悉。其实聚合函数的本质就是对一组值执行计算，并返回单个值，也被称为组函数。

比如以下数据[008-001.xlsx](008-001.xlsx)：

单号 | 姓名 | 商品 | 数量 | 成本 | 售价
- | - | - | - | - | -
1 | AAA | 酒 | 2 | 10 | 12
1 | AAA | 运费 | 1 | 3 | 3
2 | BBB | 酒 | 5 | 10 | 13
2 | BBB | 食物 | 2 | 9 | 10
2 | BBB | 运费 | 1 | 4 | 4
3 | AAA | 日用品 | 1 | 5 | 4
3 | AAA | 运费 | 1 | 1 | 1
4 | BBB | 烟 | 4 | 9 | 12
4 | BBB | 运费 | 1 | 2 | 2

投资人在拿到数据后，他可能会关心以下几个点：
- 运费不关心，对利润没有影响，在表中将数据删除。
- 不同商品的毛利润率
- 每个用户的消费金额
- 平均每单的利润与毛利润率

我们对数据做如下处理

- 加载Excel文件，并删除与"运费"相关的行。

```python
import pandas as pd
df = pd.read_excel('008-001.xlsx')
df = df[df['商品'] != '运费']
```

- 整理后的数据如下

单号 | 姓名 | 商品 | 数量 | 成本 | 售价
- | - | - | - | - | -
1 | AAA | 酒 | 2 | 10 | 12
2 | BBB | 酒 | 5 | 10 | 13
2 | BBB | 食物 | 2 | 9 | 10
3 | AAA | 日用品 | 1 | 5 | 4
4 | BBB | 烟 | 4 | 9 | 12

- 计算每个用户的消费金额

```python
# 首先计算每条记录里商品的总成本与总售价
df['总成本'] = df['数量'] * df['成本']
df['总售价'] = df['数量'] * df['售价']
# 根据用户姓名分组然后对每组数据求和（我们只关心总售价的值）
new_df = df.groupby('姓名').sum()
new_df = new_df['总售价']
new_df.reset_index() # 姓名从索引列变到普通列
```

<b>注意</b>：groupby使用聚合函数（这里是sum）后，非数值列不保留。

- 计算不同商品的毛利润率：根据商品名称进行分组（group by），对总成本与总售价求和，然后再求毛利润率。

```python
grouped = df.groupby('商品')
new_df = grouped.agg({'总成本': 'sum', '总售价': 'sum'})
new_df['毛利润率'] = (new_df['总售价'] - new_df['总成本']) / new_df['总成本']
```

<b>注意</b>：这里用agg针对不同的列指定聚合函数，而且计算结果只包括了指定的列。参数用了字典，key是列的名字，value是聚合函数的名字。这里用了字符串，代表是系统内置函数，否则直接写函数名，比如{'col_name': my_agg_func}。

可以看出，商品"烟"的利润率最高。

&nbsp; | 总成本 | 总售价 | 毛利润率
- | - | - | -
商品 | 
日用品 | 5 | 4 | -0.200000
烟 | 36 | 48 | 0.333333
酒 | 70 | 89 | 0.271429
食物 | 18 | 20 | 0.111111

- 计算平均每单的利润与毛利润率

```python
def my_sum(li): # 使用自定义聚合函数求和，输入是Pandas的Series类型，可以简单认为是数组list。
    return sum(li)

new_df = df.groupby('单号').agg({'总成本': my_sum, '总售价': my_sum})
new_df['利润'] = new_df['总售价'] - new_df['总成本']
new_df['毛利润率'] = (new_df['总售价'] - new_df['总成本']) / new_df['总成本']
```

交互题目：
1. 根据列"姓名"的值分组，并对所有数值列求平均值。
    - df.groupby('姓名').mean()
    - df.mean().groupby('姓名')

2. 数据分组后对X列应用自定义聚合函数func
    - df.groupby('AAA').agg('X': func)
    - df.groupby('AAA').agg('X': 'func')